<html>
  <head>
    <meta charset="utf-8"/>
    <title>WHBCA &mdash; Weird HomeBrew Chat API</title>
    <style type="text/css">
body { font-family: "Times New Roman", serif; }
tt, pre { font-family: "Courier New", monospace; }
h1 { text-align: center; }
p, li, aside { text-align: justify; }
pre { background: #e0e0e0; white-space: pre-wrap; }
h1, h2, h3, h4, h5, p, ul, pre, aside, hr { margin: 5px 0; }
h2, h3, h4 { margin-top: 15px; }
h5 { font-size: 1em; }
ul { padding-left: 1em; }
pre { padding: 3px 0; }
article { margin: auto; max-width: 40em; }
aside { font-style: italic; margin: 5px 1em; }
aside:first-child { margin: 5px 0; }
aside > h5:first-child { display: inline; font-style: normal; }
/* Fancy headline counting */
h2::before, h3::before, h4::before {
  font-size: 1rem;
  font-weight: normal;
  color: #808080;
}
body {
  counter-reset: h2ctr;
}
h2::before {
  content: counter(h2ctr) ". ";
  counter-increment: h2ctr;
}
h2 {
  counter-reset: h3ctr;
}
h3::before {
  content: counter(h2ctr) "." counter(h3ctr) ". ";
  counter-increment: h3ctr;
}
h3 {
  counter-reset: h4ctr;
}
h4::before {
  content: counter(h2ctr) "." counter(h3ctr) "." counter(h4ctr) ". ";
  counter-increment: h4ctr;
}
    </style>
  </head>
  <body>
    <h1>Weird HomeBrew Chat API</h1>
    <hr/>
    <article>
<aside>Revision 3, as of 2016-02-13</aside>

<h2>Preface</h2>
<p><tt>WHBCS</tt> came into existence after I had a <tt>netcat</tt> chat with
an acquaintance, showing that such a client-less chat has both the merit of
not having to install a client and the expense of the other's messages
interrupting the own typing; additionally, only two people could participate
in such a conversation. After that, I wrote up <tt>WHBCS</tt>, trying to use
some ANSI escape codes to make others' messages appear above the own one
being typed, indeed succeeding at that. As it got mildly popular within the
related circles, the topic of bots was raised, which led to this API.</p>

<h2>Basics</h2>

<h3>Low-level communication</h3>
<p>Clients communicate with the server by sending (and receiving) octets over
a TCP channel, which are to be mapped to ASCII codepoints. UTF-8 is not
employed as not all endpoints are guaranteed to use it; opt-in support may be
added upon popular demand.</p>
<p>As far as this API is concerned, communication is always line-based; lines
are terminated with the line feed (<tt>\x0A</tt>) character.</p>

<h3>Initial handshake</h3>
<p>Initially, the connection is in <em>doorstep mode</em>, the server,
assuming a human client, sends a textual greeting after a version
advertisement. A human client would configure certain properties of themself
&mdash; the terminal type and the nickname &mdash; and join; bots can enable
<em>API mode</em> instead.</p>

<h4>Server lines</h4>
<p><em>Comment lines</em> are sent for human users' information; they begin
with a number sign (<tt>#</tt>) and can be safely ignored. Lines relevant to
the API are split into <em>words</em> by whitespace; they can be
discriminated by their first word:</p>
<ul>
<li><tt>WHBCS</tt> &mdash; <strong>Version advertisement</strong>: Sent by
WHBCS as the very first line, with the version following the heading as a
second word. Additional words may be specified in the future. The version
this API applies to is <tt>v1.5</tt>, servers with a higher minor version
shall behave downwards-compatibly (though such with a higher major version
may not).</li>
<li><tt>OK</tt> &mdash; <strong>Acknowledgement</strong>: Indicates a
client-side command was successful. Further words may be specified in the
future. A word consisting of a single number sign indicates the end of
API-relevant payload and the beginning of comments for human users.</li>
<li><tt>FAIL</tt> &mdash; <strong>Failure</strong>: Indicates a command was
not successful. Syntax similar to <tt>OK</tt>.</li>
<li><tt>PONG</tt> &mdash; <strong>Ping reply</strong>: Sent as a reply to a
<tt>/ping</tt> command, which can be used to probe connection connectivity.
The syntax is again similar to <tt>OK</tt>.</li>
</ul>

<h4>Client lines</h4>
<p>For continuity with in-chat commands, client-side lines begin with a slash
(<tt>/</tt>) character. Out of the commands, only <tt>/api</tt> is relevant
to API clients, it changes the connection into API mode. The server's reply
will still conform to the protocol described in this subsection
(<i>i.e.</i>, be either a <tt>OK</tt> or a <tt>FAIL</tt>).</p>
<p>Other notable commands include <tt>/ping</tt>, which results in the server
sending a <tt>PONG</tt> reply, and <tt>/quit</tt>, which lets WHBCS terminate
the connection (after performing some clean-up, which is not necessary in API
mode); a list (with terse descriptions; <small>not including the
<tt>/api</tt> command</small>) can be obtained by using the <tt>/help</tt>
command interactively.</p>

<h3>API mode format</h3>
<p>In API mode, the commands mentioned earlier are complemented by <em>JSON
objects</em> as the main means of transporting data; the separation of words
is irrelevant for those, and should not be performed. More exactly, lines
starting with the opening brace character (<tt>{</tt>) are interpreted as
JSON messages by WHBCS, and the server sends all its messages in JSON
format.</p>
<aside><h5>Note</h5> that messages not starting with a brace will be
interpreted as in non-API mode; commands can be used and messages can be sent
(if the API client has joined properly), although this behavior is
discouraged.</aside>

<h2>API messages</h2>
<p>The client and the server may send messages at any time (asynchronously);
the server guarantees to process the client's command in the order they
arrive at the server (and, therefore, most probably are sent). As noted
above, messages are encoded as JSON objects.</p>

<h3>Common attributes</h3>
<p>This section specifies attributes common to all object types. Some of them
only apply to top-level messages.</p>
<ul>
<li><tt>type</tt> &mdash; <strong>Object type</strong>: The semantical type
of the object. The value is a string. Note that objects may be nested inside
each other, so this is not limited to message types.</li>
<li><tt>variant</tt> &mdash; <strong>Type differentiation</strong>: Indicates
a different "sub-type", or a different role an object has. As <tt>type</tt>,
the value is a string. E.g., the <tt>message</tt> type has the variants
<tt>post</tt> and <tt>emote</tt>.</li>
<li><tt>content</tt> &mdash; <strong>Main content</strong>: Stores, well, the
main content of the object. Can be of an arbitrary type.</li>
<li><tt>seq</tt> &mdash; <strong>Sequence number</strong>: An arbitrary value
set by the client in requests; server replies to those will include it
unmodified. Use is optional.</li>
<li><tt>timestamp</tt> &mdash; <strong>Timestamp</strong>: A UNIX timestamp
of when roughly the current object was constructed. The value if a
floating-point number; while the unit is a second, more precision may be
available.</li>
<li><tt>text</tt> &mdash; <strong>Textual representation</strong>: The
server's preferred way of presenting the given object, as used for terminal
clients. May be absent, indicating the server does not honor this object with
a textual representation. The value may be a string, or an array of strings
and/or nested objects, which can have <tt>text</tt> fields as well. Objects
without <tt>text</tt> fields are provided as context and would not be
rendered into text by the server itself. The emission of <tt>text</tt> fields
might be configurable in the future (to save bandwidth).</p>
</ul>

<h3>Client commands</h3>
<p>The section titles list the <tt>type</tt> attributes to set.</p>

<h4><tt>ping</tt></h4>
<p>Lets the server return a <tt>pong</tt> message. Can be used to probe
connectivity.</p>

<h4><tt>query</tt></h4>
<p>Asks the server to inform the client about some of its state.
<tt>content</tt> is a <tt><b>variable</b></tt> without a <tt>value</tt>
indicating what to query. The server returns either a
<tt><b>success</b></tt> or a <tt><b>failure</b></tt>, depending on whether
the request is valid, and whether the client is allowed to perform it.</p>

<h4><tt>update</tt></h4>
<p>Asks the server to change some client state, similarly to
<tt><b>query</b></tt>. The <tt>content</tt> contains a <tt>value</tt>, which
tells what to change the variable to.</p>

<h4><tt>join</tt></h4>
<p>Tells the server the client is ready to enter chat. A modified
<tt><b>joined</b></tt> is sent to the client as confirmation (instead of a
<tt><b>success</b></tt>).</p>

<h4><tt>leave</tt></h4>
<p>Tells the server that the client wants to leave chat again. A modified
<tt><b>left</b></tt> is sent to the client as confirmation.</p>

<h4><tt>send</tt></h4>
<p>Sends a chat message. <tt>content</tt> is a <tt><b>post</b></tt>
specifying what exactly to send. The <tt><b>post</b></tt>'s
<tt>content</tt> may be a plain string, letting the server interpret it, and
is in fact currently required to be like that. Instead of a
<tt><b>success</b></tt>, the server replies with a special
<tt><b>chat</b></tt> including the command's sequence number.</p>

<h4><tt>quit</tt></h4>
<p>Tells the server to remove the client from chat (if there) and to close
the connection.</p>

<h3>Server replies</h3>
<p>Generic synchronous replies to commands.</p>

<h4><tt>pong</tt></h4>
<p>Indicates a <tt>ping</tt> command was received.</p>

<h4><tt>success</tt></h4>
<p>Indicates that a command succeeded. <tt>content</tt> may contain reply
data.</p>

<h4><tt>failure</tt></h4>
<p>Indicates that a command failed. <tt>content</tt> contains an
<tt><b>error</b></tt> object.</p>

<h3>Asynchronous events</h3>
<p>Those messages are sent by the server when events of interest to clients
happen.</p>

<h4><tt>joined</tt></h4>
<p>A client joined the room. <tt>content</tt> is a <tt><b>user</b></tt>
object containing details about the newly-joined participant.</p>

<h4><tt>left</tt></h4>
<p>A client left. <tt>content</tt> &mdash; symmetrically to
<tt><b>joined</b></tt> &mdash; elaborates on which client exactly left.
<tt>variant</tt> may be <tt>normal</tt> or <tt>abrupt</tt>, denoting whether
the client disconnected "properly" (<i>i.e.</i>, by a <tt><b>leave</b></tt>
or a <tt><b>quit</b></tt>) or not, respectively.</p>

<h4><tt>chat</tt></h4>
<p>A chat message was posted. <tt>content</tt> contains a
<tt><b>post</b></tt> representing the chat message.</p>

<h4><tt>sysmsg</tt></h4>
<p>A system message from the server. The <tt>text</tt> fields contains
more details.</p>

<h3>In-message data types</h3>
<p>&mdash; <em>To be added</em> &mdash;</p>

    </article>
    <hr/>
  </body>
</html>
